package com.runsystem.datnt.controllers;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.security.crypto.bcrypt.BCryptPasswordEncoder;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.ModelAttribute;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestMethod;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.ResponseBody;

import com.runsystem.datnt.entities.PasswordReset;
import com.runsystem.datnt.services.interfaces.PasswordResetService;
import com.runsystem.datnt.utils.Validation;
import com.runsystem.datnt.validations.RequireResetValidator;

@Controller
public class ResetPasswordController {

	@Autowired
	private PasswordResetService resetService;
	
	@Autowired
	private BCryptPasswordEncoder passen;
	
	/*
	 * 
	 * */
	@RequestMapping(value = "/admin/accreset", method = RequestMethod.GET)
	public String loadPageAdmin(Model model) {

		model.addAttribute("user", "Admin");
		model.addAttribute("role", "ADMIN");
		model.addAttribute("listProcessed", resetService.selectProcessed());
		model.addAttribute("listUnprocess", resetService.selectUnprocess());
		return "acceptResetPassword";
	}
	
	@RequestMapping(value = "/sendreset", method = RequestMethod.GET)
	public String loadPageStudent(Model model) {
		model.addAttribute("user", "Student");
		model.addAttribute("role", "STUDENT");
		return "requireResetPassword";
	}
	
	@RequestMapping(value = "/sendreset", method = RequestMethod.POST)
	public String processRequire(@ModelAttribute PasswordReset info, Model model, BindingResult bindingResult) {
		RequireResetValidator validator = new RequireResetValidator();
		validator.validate(info, bindingResult);
		
		if (bindingResult.hasErrors()) {
			model.addAttribute("errors", true);
			return "requireResetPassword";
		}
		if ( resetService.insert(info) ) {
			model.addAttribute("success", true);
			return "requireResetPassword";
		}
		model.addAttribute("errors", true);
		return "requireResetPassword";
	}
	
	@RequestMapping(value = "/admin/accreset/{studentCode}", method = RequestMethod.GET)
	public @ResponseBody boolean acceptReset(@PathVariable("studentCode") String code, @RequestParam(value = "param", required = true) String param) {
		
		if (Validation.validCode(code)) {
			if (!Validation.isNullOrEmpty(param)) {
				if (param.equals("accept"))
			}
		}
		return false;
	}
}
